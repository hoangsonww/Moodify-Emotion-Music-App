# Moodify Backend Helm Chart - Default Values
# Override these values for different environments

environment: production
nameOverride: ""
fullnameOverride: ""

# Image configuration
image:
  repository: moodify/backend
  pullPolicy: Always
  tag: "latest"

imagePullSecrets: []

# Deployment strategy
deploymentStrategy:
  type: RollingUpdate
  rollingUpdate:
    maxSurge: 1
    maxUnavailable: 0

# Blue-green deployment configuration
blueGreen:
  enabled: true
  activeEnvironment: blue  # blue or green
  keepInactive: true

# Replica configuration
replicaCount: 3

# Autoscaling
autoscaling:
  enabled: true
  minReplicas: 3
  maxReplicas: 15
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80
  customMetrics:
    - type: Pods
      pods:
        metric:
          name: http_requests_per_second
        target:
          type: AverageValue
          averageValue: "1000"

# Pod Disruption Budget
podDisruptionBudget:
  enabled: true
  minAvailable: 2

# Service Account
serviceAccount:
  create: true
  annotations: {}
  name: "moodify-backend-sa"

# Security Context
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000

securityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: true
  runAsNonRoot: true
  runAsUser: 1000
  capabilities:
    drop:
      - ALL

# Resources
resources:
  requests:
    memory: "512Mi"
    cpu: "500m"
  limits:
    memory: "2Gi"
    cpu: "2000m"

# Probes
livenessProbe:
  httpGet:
    path: /health/live
    port: 8000
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /health/ready
    port: 8000
  initialDelaySeconds: 10
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3

startupProbe:
  httpGet:
    path: /health/startup
    port: 8000
  initialDelaySeconds: 0
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 30

# Init containers
initContainers:
  waitForDB:
    enabled: true
    image: busybox:1.36
    env:
      DB_HOST: documentdb-service
      DB_PORT: "27017"

  waitForRedis:
    enabled: true
    image: busybox:1.36
    env:
      REDIS_HOST: redis-service
      REDIS_PORT: "6379"

  runMigrations:
    enabled: true
    command: ['python', 'manage.py', 'migrate', '--no-input']

# Sidecars
sidecars:
  fluentBit:
    enabled: true
    image: fluent/fluent-bit:2.1
    resources:
      requests:
        memory: "64Mi"
        cpu: "100m"
      limits:
        memory: "128Mi"
        cpu: "200m"

# Service configuration
service:
  type: ClusterIP
  port: 8000
  targetPort: 8000
  metricsPort: 9090
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "8000"
    prometheus.io/path: "/metrics"

# Ingress
ingress:
  enabled: true
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/rate-limit: "100"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
  hosts:
    - host: api.moodify.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: moodify-backend-tls
      hosts:
        - api.moodify.com

# Environment variables from ConfigMap
configMap:
  data:
    NODE_ENV: production
    LOG_LEVEL: info
    DB_HOST: documentdb-service
    DB_PORT: "27017"
    REDIS_HOST: redis-service
    REDIS_PORT: "6379"

# Secrets
secrets:
  create: true
  data: {}  # Populated by External Secrets Operator

# Volumes
volumes:
  tmp:
    enabled: true
    emptyDir: {}
  cache:
    enabled: true
    emptyDir: {}
  logs:
    enabled: true
    emptyDir: {}

# Volume mounts
volumeMounts:
  - name: tmp
    mountPath: /tmp
  - name: cache
    mountPath: /app/cache
  - name: logs
    mountPath: /app/logs

# Node affinity
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app
                operator: In
                values:
                  - moodify-backend
          topologyKey: kubernetes.io/hostname

# Tolerations
tolerations: []

# Node selector
nodeSelector: {}

# Monitoring
monitoring:
  enabled: true
  serviceMonitor: true
  prometheusRule: true

# Network Policy
networkPolicy:
  enabled: true
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: moodify-production
      ports:
        - protocol: TCP
          port: 8000
  egress:
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 27017  # MongoDB
        - protocol: TCP
          port: 6379   # Redis
        - protocol: TCP
          port: 443    # HTTPS

# Additional labels
additionalLabels: {}

# Additional annotations
additionalAnnotations: {}
